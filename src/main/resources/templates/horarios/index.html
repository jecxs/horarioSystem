<!DOCTYPE html>
    <html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(~{::title}, ~{::div#content}, ~{::style}, ~{::script})}">
<head>

    <title>Tablero de Horarios</title>
    <style th:replace="~{horarios/fragments/styles :: styles}"></style>
</head>
<body>
<div id="content">
    <!-- Cabecera y selector de docente -->
    <div th:replace="~{horarios/fragments/cabecera :: cabecera}"></div>

    <!-- Tabla de horario -->
    <div th:replace="~{horarios/fragments/tabla-horario :: tabla-horario}"></div>

    <!-- Leyenda -->
    <div th:replace="~{horarios/fragments/leyenda :: leyenda}"></div>

    <!-- Modales -->
    <div th:replace="~{horarios/fragments/modals/docente-modal :: modal}"></div>
    <div th:replace="~{horarios/fragments/modals/disponibilidad-modal :: modal}"></div>
    <div th:replace="~{horarios/fragments/modals/asignacion-modal :: modal}"></div>
    <div th:replace="~{horarios/fragments/modals/curso-modal :: modal}"></div>
    <div th:replace="~{horarios/fragments/modals/carrera-modal :: modal}"></div>
    <div th:replace="~{horarios/fragments/modals/ciclo-modal :: modal}"></div>
    <div th:replace="~{horarios/fragments/modals/modalidad-modal :: modal}"></div>
    <div th:replace="~{horarios/fragments/modals/ambiente-modal :: modal}"></div>
    <div th:replace="~{horarios/fragments/modals/turno-modal :: modal}"></div>
    <div th:replace="~{horarios/fragments/modals/grupo-modal :: modal}"></div>

</div>

<script>
    // Script para la gestión del horario
    $(document).ready(function() {
        let docenteSeleccionado = null;
        let horarioData = null;

        // Cargar horario al seleccionar docente
        $("#btnVerHorario").click(function() {
            const docenteId = $("#selectDocente").val();
            if (!docenteId) {
                alert("Por favor seleccione un docente");
                return;
            }

            cargarHorarioDocente(docenteId);
        });

        function cargarHorarioDocente(docenteId) {
            $.ajax({
                url: `/horarios/docente/${docenteId}`,
                method: "GET",
                success: function(data) {
                    docenteSeleccionado = data.docente;
                    horarioData = data;
                    mostrarInfoDocente();
                    construirTablaHorario();
                    $("#btnNuevaAsignacion").show();
                },
                error: function() {
                    alert("Error al cargar el horario del docente");
                }
            });
        }


// Modificar la función mostrarInfoDocente para añadir información sobre disponibilidad
        function mostrarInfoDocente() {
            $("#nombreDocente").text(docenteSeleccionado.nombreCompleto);
            $("#especialidadDocente").text(docenteSeleccionado.especialidad || "Sin especialidad");

            // Añadir información sobre disponibilidad
            let disponibilidadHTML = '';

            if (docenteSeleccionado.disponibilidades && docenteSeleccionado.disponibilidades.length > 0) {
                disponibilidadHTML = `
            <div class="mt-2">
                <span class="badge bg-success">Disponible</span>
                ${docenteSeleccionado.disponibilidades.length} horarios registrados
                <button class="btn btn-link btn-sm text-decoration-none" data-bs-toggle="modal" data-bs-target="#modalDisponibilidad">
                    Ver detalles
                </button>
            </div>
        `;
            } else {
                disponibilidadHTML = `
            <div class="mt-2 text-danger">
                <i class="bi bi-exclamation-triangle-fill"></i>
                No hay horarios de disponibilidad registrados
                <button class="btn btn-link btn-sm text-decoration-none" data-bs-toggle="modal" data-bs-target="#modalDisponibilidad">
                    Registrar disponibilidad
                </button>
            </div>
        `;
            }

            // Añadir resumen de asignaciones
            let totalAsignaciones = 0;
            for (const dia in horarioData.asignacionesPorDia) {
                totalAsignaciones += horarioData.asignacionesPorDia[dia].length;
            }

            let asignacionesHTML = `
        <div class="mt-2">
            <span class="badge bg-primary">Asignaciones</span>
            ${totalAsignaciones} sesiones asignadas
        </div>
    `;

            $("#infoDocente").html(`
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">${docenteSeleccionado.nombreCompleto}</h5>
                <p class="card-text">${docenteSeleccionado.especialidad || "Sin especialidad"}</p>
                ${disponibilidadHTML}
                ${asignacionesHTML}
            </div>
        </div>
    `).show();

            $("#asignacionDocenteId").val(docenteSeleccionado.idDocente);
            cargarDisponibilidadDocente();
        }

        // Modificar la función construirTablaHorario para mejorar la visualización de disponibilidad
        function construirTablaHorario() {
            // Obtener todos los bloques para construir la tabla
            $.ajax({
                url: "/ambientes/bloques",
                method: "GET",
                success: function(bloques) {
                    const tbody = $("#tablaHorario tbody");
                    tbody.empty();

                    // Ordenar bloques por hora de inicio
                    bloques.sort((a, b) => {
                        return a.horaInicio.localeCompare(b.horaInicio);
                    });

                    // Crear filas para cada bloque
                    bloques.forEach(bloque => {
                        const tr = $("<tr>");

                        // Celda del bloque (primera columna)
                        tr.append(`<td class="fw-bold">${bloque.horaInicio.substring(0, 5)} - ${bloque.horaFin.substring(0, 5)}</td>`);

                        // Celdas para cada día de la semana
                        for (const dia of ["Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sabado"]) {
                            // Buscar disponibilidad para este bloque en este día
                            const disponibleInfo = horarioData.disponibilidadPorDia[dia].find(b => b.bloqueId === bloque.idBloque);

                            // Buscar asignaciones para este bloque en este día
                            const asignaciones = horarioData.asignacionesPorDia[dia].filter(a =>
                                a.bloques.some(b => b.idBloque === bloque.idBloque)
                            );

                            const td = $("<td>");

                            if (asignaciones && asignaciones.length > 0) {
                                // Hay una asignación para este bloque
                                td.addClass("bloque-asignado");
                                const asignacion = asignaciones[0];

                                // Encontrar la disponibilidad correspondiente (si existe)
                                const disponibilidad = docenteSeleccionado.disponibilidades.find(d =>
                                    d.diaSemana === dia && estaEnHorario(bloque.horaInicio, bloque.horaFin, d.horaInicio, d.horaFin)
                                );

                                // Añadir indicador de disponibilidad si corresponde
                                if (disponibilidad) {
                                    td.append(`<span class="indicador-disponibilidad bg-success text-white">D</span>`);
                                }

                                td.append(`
                            <div class="asignacion-item" data-id="${asignacion.id}">
                                <strong>${asignacion.curso.nombre}</strong><br>
                                <small>${asignacion.grupo.nombre} | ${asignacion.ambiente.nombre}</small>
                                <button class="btn btn-sm btn-danger float-end btn-borrar-asignacion"
                                    data-id="${asignacion.id}" data-bs-toggle="tooltip" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        `);

                                // Añadir tooltip con información detallada
                                td.attr("data-bs-toggle", "tooltip");
                                td.attr("data-bs-html", "true");
                                td.attr("title", `
                            <strong>Curso:</strong> ${asignacion.curso.nombre}<br>
                            <strong>Grupo:</strong> ${asignacion.grupo.nombre}<br>
                            <strong>Ambiente:</strong> ${asignacion.ambiente.nombre}<br>
                            <strong>Tipo:</strong> ${asignacion.tipoSesion}
                        `);

                                // Evento para eliminar asignación
                                td.find(".btn-borrar-asignacion").click(function(e) {
                                    e.stopPropagation();
                                    const asignacionId = $(this).data("id");
                                    if (confirm("¿Está seguro de eliminar esta asignación?")) {
                                        eliminarAsignacion(asignacionId);
                                    }
                                });
                            } else if (disponibleInfo && disponibleInfo.disponible) {
                                // El bloque está disponible
                                td.addClass("bloque-disponible");
                                td.attr("data-dia", dia);
                                td.attr("data-bloque", bloque.idBloque);

                                // Encontrar la disponibilidad correspondiente
                                const disponibilidad = docenteSeleccionado.disponibilidades.find(d =>
                                    d.diaSemana === dia && estaEnHorario(bloque.horaInicio, bloque.horaFin, d.horaInicio, d.horaFin)
                                );

                                // Añadir información sobre la disponibilidad como tooltip
                                if (disponibilidad) {
                                    td.attr("data-bs-toggle", "tooltip");
                                    td.attr("data-bs-html", "true");
                                    td.attr("data-bs-placement", "top");
                                    td.attr("title", `
                                <strong>Disponible:</strong> ${disponibilidad.horaInicio.substring(0, 5)} - ${disponibilidad.horaFin.substring(0, 5)}<br>
                                <strong>Haga clic para asignar</strong>
                            `);

                                    // Añadir indicador visual de disponibilidad
                                    td.append(`<i class="bi bi-check-circle-fill text-success position-absolute" style="top: 5px; right: 5px; opacity: 0.7;"></i>`);

                                    // Texto indicativo para guiar al usuario
                                    td.append(`<div class="text-center text-success" style="font-size: 12px; opacity: 0.7;">Disponible</div>`);
                                }

                                // Evento para crear nueva asignación
                                td.click(function() {
                                    iniciarNuevaAsignacion(dia, bloque.idBloque);
                                });
                            } else {
                                // No disponible
                                td.addClass("bloque-nodisponible");

                                // Añadir tooltip para indicar que no está disponible
                                td.attr("data-bs-toggle", "tooltip");
                                td.attr("data-bs-html", "true");
                                td.attr("title", "No disponible en este horario");
                            }

                            tr.append(td);
                        }

                        tbody.append(tr);
                    });

                    // Inicializar tooltips con opciones personalizadas
                    $('[data-bs-toggle="tooltip"]').tooltip({
                        template: '<div class="tooltip tooltip-disponibilidad" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'
                    });
                },
                error: function() {
                    alert("Error al cargar los bloques de horario");
                }
            });
        }
        // Función auxiliar para verificar si un bloque está dentro del horario de disponibilidad
        function estaEnHorario(bloqueInicio, bloqueFin, dispInicio, dispFin) {
            // Convertir a minutos para facilitar la comparación
            function timeToMinutes(time) {
                const parts = time.split(':');
                return parseInt(parts[0]) * 60 + parseInt(parts[1]);
            }

            const bloqueInicioMin = timeToMinutes(bloqueInicio);
            const bloqueFinMin = timeToMinutes(bloqueFin);
            const dispInicioMin = timeToMinutes(dispInicio);
            const dispFinMin = timeToMinutes(dispFin);

            // El bloque está dentro del horario de disponibilidad si:
            // - La hora de inicio del bloque es >= a la hora de inicio de la disponibilidad
            // - La hora de fin del bloque es <= a la hora de fin de la disponibilidad
            return bloqueInicioMin >= dispInicioMin && bloqueFinMin <= dispFinMin;
        }

        function iniciarNuevaAsignacion(dia, bloqueId) {
            // Preparar el modal de asignación
            $("#modalAsignacion").modal("show");
            $("#asignacionDia").val(dia);

            // Cargar bloques disponibles para ese día
            cargarBloquesDisponibles(dia, bloqueId);

            // Resetear formulario
            $("#asignacionModalidad").val("");
            $("#asignacionCarrera").val("").prop("disabled", true);
            $("#asignacionCiclo").val("").prop("disabled", true);
            $("#asignacionCurso").val("").prop("disabled", true);
            $("#asignacionGrupo").val("").prop("disabled", true);
            $("#asignacionTipoSesion").val("");
            $("#asignacionAmbiente").val("");
        }

        function cargarBloquesDisponibles(dia, bloqueIdSeleccionado) {
            const selectBloques = $("#asignacionBloques");
            selectBloques.empty();

            // Filtrar bloques disponibles para el día seleccionado
            const bloquesDisponibles = horarioData.disponibilidadPorDia[dia].filter(b => b.disponible);

            bloquesDisponibles.forEach(bloque => {
                const option = $("<option>")
                    .val(bloque.bloqueId)
                    .text(`${bloque.horaInicio.substring(0, 5)} - ${bloque.horaFin.substring(0, 5)}`)
                    .prop("selected", bloque.bloqueId === bloqueIdSeleccionado);

                selectBloques.append(option);
            });
        }

        // Crear nuevo docente
        $("#btnGuardarDocente").click(function() {
            const nombreCompleto = $("#nombreCompleto").val();
            const especialidad = $("#especialidad").val();

            if (!nombreCompleto) {
                alert("El nombre del docente es obligatorio");
                return;
            }

            const docenteDTO = {
                nombreCompleto: nombreCompleto,
                especialidad: especialidad,
                disponibilidades: []
            };

            $.ajax({
                url: "/docentes",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(docenteDTO),
                success: function(docente) {
                    // Agregar el nuevo docente al select
                    $("#selectDocente").append(new Option(docente.nombreCompleto, docente.idDocente));
                    $("#modalDocente").modal("hide");
                    $("#formDocente")[0].reset();

                    // Seleccionar el nuevo docente
                    $("#selectDocente").val(docente.idDocente);
                    cargarHorarioDocente(docente.idDocente);
                },
                error: function() {
                    alert("Error al crear el docente");
                }
            });
        });

        // Gestión de disponibilidad
        function cargarDisponibilidadDocente() {
            const tbody = $("#tablaDisponibilidad tbody");
            tbody.empty();

            if (!docenteSeleccionado.disponibilidades || docenteSeleccionado.disponibilidades.length === 0) {
                tbody.append(`<tr><td colspan="4" class="text-center">No hay disponibilidades registradas</td></tr>`);
                return;
            }

            docenteSeleccionado.disponibilidades.forEach(disp => {
                const tr = $("<tr>");
                tr.append(`<td>${disp.diaSemana}</td>`);
                tr.append(`<td>${disp.horaInicio.substring(0, 5)}</td>`);
                tr.append(`<td>${disp.horaFin.substring(0, 5)}</td>`);
                tr.append(`
                        <td>
                            <button class="btn btn-sm btn-danger btn-eliminar-disponibilidad" data-id="${disp.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `);
                tbody.append(tr);
            });

            // Evento para eliminar disponibilidad
            $(".btn-eliminar-disponibilidad").click(function() {
                const dispId = $(this).data("id");
                if (confirm("¿Está seguro de eliminar esta disponibilidad?")) {
                    eliminarDisponibilidad(dispId);
                }
            });
        }

        $("#btnAgregarDisponibilidad").click(function() {
            const dia = $("#diaSemana").val();
            const horaInicio = $("#horaInicio").val();
            const horaFin = $("#horaFin").val();

            if (!dia || !horaInicio || !horaFin) {
                alert("Todos los campos son obligatorios");
                return;
            }

            if (horaInicio >= horaFin) {
                alert("La hora de inicio debe ser menor a la hora de fin");
                return;
            }

            $.ajax({
                url: `/docentes/${docenteSeleccionado.idDocente}/disponibilidad`,
                method: "POST",
                data: {
                    diaSemana: dia,
                    horaInicio: horaInicio,
                    horaFin: horaFin
                },
                success: function(disponibilidad) {
                    // Actualizar datos del docente
                    if (!docenteSeleccionado.disponibilidades) {
                        docenteSeleccionado.disponibilidades = [];
                    }
                    docenteSeleccionado.disponibilidades.push(disponibilidad);

                    // Recargar tabla y horario
                    cargarDisponibilidadDocente();
                    cargarHorarioDocente(docenteSeleccionado.idDocente);

                    // Limpiar formulario
                    $("#diaSemana").val("");
                    $("#horaInicio").val("");
                    $("#horaFin").val("");
                },
                error: function() {
                    alert("Error al agregar disponibilidad");
                }
            });
        });

        function eliminarDisponibilidad(id) {
            $.ajax({
                url: `/docentes/disponibilidad/${id}`,
                method: "DELETE",
                success: function() {
                    // Actualizar datos del docente
                    docenteSeleccionado.disponibilidades = docenteSeleccionado.disponibilidades.filter(
                        d => d.id !== id
                    );

                    // Recargar tabla y horario
                    cargarDisponibilidadDocente();
                    cargarHorarioDocente(docenteSeleccionado.idDocente);
                },
                error: function() {
                    alert("Error al eliminar la disponibilidad");
                }
            });
        }

        // Gestión de asignaciones
        $("#btnGuardarAsignacion").click(function() {
            const docenteId = $("#asignacionDocenteId").val();
            const dia = $("#asignacionDia").val();
            const bloqueIds = Array.from($("#asignacionBloques").val()).map(Number);
            const cursoId = $("#asignacionCurso").val();
            const grupoId = $("#asignacionGrupo").val();
            const tipoSesion = $("#asignacionTipoSesion").val();
            const ambienteId = $("#asignacionAmbiente").val();

            if (!docenteId || !dia || bloqueIds.length === 0 || !cursoId || !grupoId || !tipoSesion || !ambienteId) {
                alert("Todos los campos son obligatorios");
                return;
            }

            const asignacionDTO = {
                docenteId: Number(docenteId),
                diaSemana: dia,
                bloqueIds: bloqueIds,
                cursoId: Number(cursoId),
                grupoId: Number(grupoId),
                tipoSesion: tipoSesion,
                ambienteId: Number(ambienteId)
            };

            // Verificar disponibilidad antes de crear
            $.ajax({
                url: "/horarios/verificar-disponibilidad",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(asignacionDTO),
                success: function(disponible) {
                    if (disponible) {
                        crearAsignacion(asignacionDTO);
                    } else {
                        alert("No es posible crear la asignación debido a conflictos de horario");
                    }
                },
                error: function() {
                    alert("Error al verificar disponibilidad");
                }
            });
        });

        function crearAsignacion(asignacionDTO) {
            $.ajax({
                url: "/horarios/asignacion",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(asignacionDTO),
                success: function() {
                    $("#modalAsignacion").modal("hide");
                    // Recargar horario
                    cargarHorarioDocente(docenteSeleccionado.idDocente);

                    // Mostrar mensaje de éxito
                    mostrarAlertaGlobal("success", "La asignación ha sido creada exitosamente.");
                },
                error: function(xhr) {
                    // Verificar si es un error de límite de horas
                    if (xhr.responseText && xhr.responseText.includes("excede el total de horas")) {
                        mostrarModalErrorHoras(xhr.responseText);
                    } else if (xhr.responseText) {
                        mostrarAlertaGlobal("danger", xhr.responseText);
                    } else {
                        mostrarAlertaGlobal("danger", "Error al crear la asignación");
                    }
                }
            });
        }
        // Función para mostrar un modal personalizado para errores de horas
        function mostrarModalErrorHoras(mensaje) {
            // Extraer datos del mensaje de error
            const regex = /Horas ya asignadas: (\d+), Horas a asignar: (\d+), Horas semanales del curso: (\d+)/;
            const matches = mensaje.match(regex);

            let horasAsignadas = 0;
            let horasNuevas = 0;
            let horasTotales = 0;

            if (matches && matches.length >= 4) {
                horasAsignadas = parseInt(matches[1]);
                horasNuevas = parseInt(matches[2]);
                horasTotales = parseInt(matches[3]);
            }

            // Crear modal para mostrar la información de error de horas
            const modal = `
    <div class="modal fade" id="modalErrorHoras" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Error en la asignación de horas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>La asignación excede el total de horas semanales permitidas para este curso.</strong>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <tr>
                                <th>Horas totales del curso</th>
                                <td class="text-center">${horasTotales} horas pedagógicas</td>
                            </tr>
                            <tr>
                                <th>Horas ya asignadas</th>
                                <td class="text-center">${horasAsignadas} horas pedagógicas</td>
                            </tr>
                            <tr>
                                <th>Horas que intentas asignar</th>
                                <td class="text-center">${horasNuevas} horas pedagógicas</td>
                            </tr>
                            <tr class="table-danger">
                                <th>Exceso de horas</th>
                                <td class="text-center">${horasAsignadas + horasNuevas - horasTotales} horas pedagógicas</td>
                            </tr>
                        </table>
                    </div>

                    <p>Por favor, reduce la cantidad de bloques seleccionados o elimina algunas asignaciones existentes para este curso.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    `;

            // Eliminar modal anterior si existe
            $("#modalErrorHoras").remove();

            // Añadir el modal al DOM y mostrarlo
            $("body").append(modal);
            const modalEl = new bootstrap.Modal(document.getElementById('modalErrorHoras'));
            modalEl.show();
        }

// Función para mostrar alertas globales
        function mostrarAlertaGlobal(tipo, mensaje) {
            const alertaHTML = `
        <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
    `;

            // Insertar la alerta al principio del contenido principal
            $("#content").prepend(alertaHTML);

            // Auto-ocultar después de 5 segundos
            setTimeout(() => {
                $(".alert-dismissible").alert('close');
            }, 5000);
        }

        // Actualizar el evento del curso para mostrar información de horas
        // Modificar el evento de cambio de curso
        $("#asignacionCurso").change(function() {
            const cursoId = $(this).val();
            const grupoId = $("#asignacionGrupo").val();

            if (!cursoId || !grupoId) {
                $("#infoCursoHoras").hide();
                $("#infoTipoCurso").hide();
                return;
            }

            // Obtener información del curso seleccionado
            $.ajax({
                url: `/cursos/${cursoId}`,
                method: "GET",
                success: function(curso) {
                    // Mostrar información de horas
                    // (código existente para mostrar horas...)

                    // Manejar el tipo de curso
                    switch(curso.tipo) {
                        case "Teorico":
                            // Si es teórico, fijar como teórica y deshabilitar cambio
                            $("#asignacionTipoSesion").val("Teorica").prop("disabled", true);
                            // Mostrar mensaje informativo
                            $("#infoTipoCurso").html(`
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            Este curso está definido como <strong>Teórico</strong>. La sesión será teórica.
                            <a href="#" class="alert-link" data-bs-toggle="modal" data-bs-target="#modalCurso">Editar curso</a>
                        </div>
                    `).show();
                            // Cargar ambientes teóricos
                            cargarAmbientesPorTipo("Teorico");
                            break;

                        case "Practico":
                            // Si es práctico, fijar como práctica y deshabilitar cambio
                            $("#asignacionTipoSesion").val("Practica").prop("disabled", true);
                            // Mostrar mensaje informativo
                            $("#infoTipoCurso").html(`
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            Este curso está definido como <strong>Práctico</strong>. La sesión será práctica.
                            <a href="#" class="alert-link" data-bs-toggle="modal" data-bs-target="#modalCurso">Editar curso</a>
                        </div>
                    `).show();
                            // Cargar ambientes prácticos
                            cargarAmbientesPorTipo("Practico");
                            break;

                        case "Mixto":
                            // Si es mixto, habilitar selección
                            $("#asignacionTipoSesion").val("").prop("disabled", false);
                            // Mostrar mensaje informativo
                            $("#infoTipoCurso").html(`
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            Este curso está definido como <strong>Mixto</strong>. Seleccione el tipo de sesión.
                        </div>
                    `).show();
                            // Limpiar ambientes
                            $("#asignacionAmbiente").empty().append('<option value="">Seleccione tipo de sesión primero...</option>');
                            break;
                    }
                }
            });
        });

        // Función para cargar ambientes por tipo
        function cargarAmbientesPorTipo(tipoAmbiente) {
            $.ajax({
                url: `/horarios/ambientes`,
                method: "GET",
                data: { tipo: tipoAmbiente },
                success: function(ambientes) {
                    const select = $("#asignacionAmbiente");
                    select.empty().append('<option value="">Seleccione...</option>');

                    ambientes.forEach(ambiente => {
                        select.append(new Option(`${ambiente.nombre} (Cap: ${ambiente.capacidad})`, ambiente.idAmbiente));
                    });
                }
            });
        }

        // Función para mostrar información de horas del curso
        function mostrarInformacionHorasCurso(estado, horasTotales, horasAsignadas, horasFaltantes) {
            let alertClass = "info";
            let mensaje = "";

            if (estado === 'COMPLETO') {
                alertClass = "success";
                mensaje = `
            <i class="bi bi-check-circle-fill me-2"></i>
            Las <strong>${horasTotales} horas pedagógicas</strong> semanales de este curso
            han sido asignadas completamente.
        `;
            } else if (estado === 'PARCIAL') {
                alertClass = "warning";
                mensaje = `
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            Faltan <strong>${horasFaltantes} horas pedagógicas</strong> por asignar para completar
            el total de <strong>${horasTotales} horas</strong> semanales de este curso.
            Actualmente hay <strong>${horasAsignadas} horas</strong> asignadas.
        `;
            } else {
                // SIN_ASIGNAR
                alertClass = "info";
                mensaje = `
            <i class="bi bi-info-circle-fill me-2"></i>
            Este curso requiere un total de <strong>${horasTotales} horas pedagógicas</strong> semanales.
            Aún no tiene ninguna hora asignada.
        `;
            }

            // Mostrar la información en el contenedor
            $("#infoCursoHoras").html(`
        <div class="alert alert-${alertClass}">
            ${mensaje}
        </div>
    `).show();
        }

// Al cambiar el grupo, verificar las horas disponibles
        $("#asignacionGrupo").change(function() {
            const cursoId = $("#asignacionCurso").val();
            const grupoId = $(this).val();

            if (cursoId && grupoId) {
                verificarHorasCurso(cursoId, grupoId);
            } else {
                $("#infoCursoHoras").hide();
            }
        });

        // Función para verificar las horas disponibles para un curso/grupo
        function verificarHorasCurso(cursoId, grupoId) {
            $.ajax({
                url: "/horarios/verificar-horas-curso",
                method: "GET",
                data: {
                    cursoId: cursoId,
                    grupoId: grupoId
                },
                success: function(data) {
                    let alertClass = "info";
                    let mensaje = "";

                    if (data.horasFaltantes > 0) {
                        alertClass = "warning";
                        mensaje = `
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Faltan <strong>${data.horasFaltantes} horas pedagógicas</strong> por asignar para completar
                    el total de <strong>${data.horasTotales} horas</strong> semanales de este curso.
                `;
                    } else if (data.horasFaltantes === 0) {
                        alertClass = "success";
                        mensaje = `
                    <i class="bi bi-check-circle-fill me-2"></i>
                    Las <strong>${data.horasTotales} horas pedagógicas</strong> semanales de este curso
                    han sido asignadas completamente.
                `;
                    } else {
                        // Caso donde se han asignado de más (no debería ocurrir con las validaciones)
                        alertClass = "danger";
                        mensaje = `
                    <i class="bi bi-exclamation-circle-fill me-2"></i>
                    Se han asignado <strong>${data.horasAsignadas} horas pedagógicas</strong>,
                    excediendo las <strong>${data.horasTotales} horas</strong> semanales requeridas
                    para este curso por <strong>${-data.horasFaltantes} horas</strong>.
                `;
                    }

                    // Mostrar la información en el contenedor
                    $("#infoCursoHoras").html(`
                <div class="alert alert-${alertClass}">
                    ${mensaje}
                </div>
            `).show();

                    // Si hay bloques seleccionados, actualizar la información con la proyección
                    const bloqueSeleccionados = $("#asignacionBloques").val();
                    if (bloqueSeleccionados && bloqueSeleccionados.length > 0) {
                        calcularHorasBloquesSeleccionados(bloqueSeleccionados, data);
                    }
                }
            });
        }

// Función para calcular y mostrar información sobre los bloques seleccionados
        function calcularHorasBloquesSeleccionados(bloqueIds, dataCurso) {
            $.ajax({
                url: "/horarios/calcular-horas-bloques",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(bloqueIds),
                success: function(horasBloques) {
                    const horasRestantes = dataCurso.horasFaltantes - horasBloques;
                    let mensaje = "";
                    let alertClass = "info";

                    if (horasRestantes > 0) {
                        alertClass = "warning";
                        mensaje = `
                    Con los bloques seleccionados (${horasBloques} horas),
                    aún faltarían <strong>${horasRestantes} horas</strong> por asignar.
                `;
                    } else if (horasRestantes === 0) {
                        alertClass = "success";
                        mensaje = `
                    ¡Perfecto! Con los bloques seleccionados (${horasBloques} horas),
                    completarás exactamente las horas requeridas.
                `;
                    } else {
                        alertClass = "danger";
                        mensaje = `
                    ¡Atención! Con los bloques seleccionados (${horasBloques} horas),
                    excederás las horas requeridas por <strong>${-horasRestantes} horas</strong>.
                `;
                    }

                    // Añadir esta información al contenedor
                    $("#infoBloquesSeleccionados").html(`
                <div class="alert alert-${alertClass} mt-2">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    ${mensaje}
                </div>
            `).show();
                }
            });
        }

// Evento al cambiar la selección de bloques
        $("#asignacionBloques").change(function() {
            const bloqueIds = $(this).val();
            const cursoId = $("#asignacionCurso").val();
            const grupoId = $("#asignacionGrupo").val();

            if (bloqueIds && bloqueIds.length > 0 && cursoId && grupoId) {
                // Obtener datos del estado del curso
                const selectedOption = $("#asignacionCurso").find('option:selected');
                const horasTotales = selectedOption.data('horasTotales');
                const horasAsignadas = selectedOption.data('horasAsignadas');
                const horasFaltantes = horasTotales - horasAsignadas;

                // Verificar si los bloques seleccionados son adecuados
                calcularHorasBloquesSeleccionados(bloqueIds, {
                    horasTotales: horasTotales,
                    horasAsignadas: horasAsignadas,
                    horasFaltantes: horasFaltantes
                });
            } else {
                $("#infoBloquesSeleccionados").hide();
            }
        });
        // Función para calcular y mostrar información sobre los bloques seleccionados
        function calcularHorasBloquesSeleccionados(bloqueIds, dataCurso) {
            $.ajax({
                url: "/horarios/calcular-horas-bloques",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(bloqueIds),
                success: function(horasBloques) {
                    const horasRestantes = dataCurso.horasFaltantes - horasBloques;
                    let mensaje = "";
                    let alertClass = "info";

                    if (horasRestantes > 0) {
                        alertClass = "warning";
                        mensaje = `
                    Con los bloques seleccionados (${horasBloques} horas),
                    aún faltarían <strong>${horasRestantes} horas</strong> por asignar.
                `;
                    } else if (horasRestantes === 0) {
                        alertClass = "success";
                        mensaje = `
                    ¡Perfecto! Con los bloques seleccionados (${horasBloques} horas),
                    completarás exactamente las horas requeridas.
                `;
                    } else {
                        alertClass = "danger";
                        mensaje = `
                    ¡Atención! Con los bloques seleccionados (${horasBloques} horas),
                    excederás las horas requeridas por <strong>${-horasRestantes} horas</strong>.
                `;
                    }

                    // Añadir esta información al contenedor
                    $("#infoBloquesSeleccionados").html(`
                <div class="alert alert-${alertClass} mt-2">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    ${mensaje}
                </div>
            `).show();
                }
            });
        }

        function eliminarAsignacion(id) {
            $.ajax({
                url: `/horarios/asignacion/${id}`,
                method: "DELETE",
                success: function() {
                    // Recargar horario
                    cargarHorarioDocente(docenteSeleccionado.idDocente);
                },
                error: function() {
                    alert("Error al eliminar la asignación");
                }
            });
        }

        // Eventos de selección encadenados para el formulario de asignación
        $("#asignacionModalidad").change(function() {
            const modalidadId = $(this).val();
            if (!modalidadId) {
                $("#asignacionCarrera").empty().append('<option value="">Seleccione modalidad primero...</option>').prop("disabled", true);
                resetearSeleccionesPosteriores("asignacionCarrera");
                return;
            }

            // Cargar carreras por modalidad
            $.ajax({
                url: `/cursos/carreras/modalidad/${modalidadId}`,
                method: "GET",
                success: function(carreras) {
                    const select = $("#asignacionCarrera");
                    select.empty().append('<option value="">Seleccione...</option>');

                    carreras.forEach(carrera => {
                        select.append(new Option(carrera.nombre, carrera.idCarrera));
                    });

                    select.prop("disabled", false);
                    resetearSeleccionesPosteriores("asignacionCarrera");
                },
                error: function() {
                    alert("Error al cargar las carreras");
                }
            });
        });

        $("#asignacionCarrera").change(function() {
            const carreraId = $(this).val();
            if (!carreraId) {
                $("#asignacionCiclo").empty().append('<option value="">Seleccione carrera primero...</option>').prop("disabled", true);
                resetearSeleccionesPosteriores("asignacionCiclo");
                return;
            }

            // Cargar ciclos por carrera
            $.ajax({
                url: `/cursos/ciclos/carrera/${carreraId}`,
                method: "GET",
                success: function(ciclos) {
                    const select = $("#asignacionCiclo");
                    select.empty().append('<option value="">Seleccione...</option>');

                    ciclos.forEach(ciclo => {
                        select.append(new Option(`Ciclo ${ciclo.numero}`, ciclo.idCiclo));
                    });

                    select.prop("disabled", false);
                    resetearSeleccionesPosteriores("asignacionCiclo");
                },
                error: function() {
                    alert("Error al cargar los ciclos");
                }
            });
        });

        $("#asignacionCiclo").change(function() {
            const cicloId = $(this).val();
            if (!cicloId) {
                $("#asignacionGrupo").empty().append('<option value="">Seleccione ciclo primero...</option>').prop("disabled", true);
                resetearSeleccionesPosteriores("asignacionGrupo");
                return;
            }

            // Cargar grupos por ciclo
            $.ajax({
                url: `/horarios/grupos/ciclo/${cicloId}`,
                method: "GET",
                success: function(grupos) {
                    const select = $("#asignacionGrupo");
                    select.empty().append('<option value="">Seleccione...</option>');

                    if (grupos.length === 0) {
                        select.append('<option value="" disabled>No hay grupos registrados para este ciclo</option>');
                    } else {
                        grupos.forEach(grupo => {
                            select.append(new Option(grupo.nombre, grupo.idGrupo));
                        });
                    }

                    select.prop("disabled", false);
                    resetearSeleccionesPosteriores("asignacionGrupo");
                },
                error: function() {
                    alert("Error al cargar los grupos");
                }
            });
        });
        $("#asignacionGrupo").change(function() {
            const grupoId = $(this).val();
            const cicloId = $("#asignacionCiclo").val();

            if (!grupoId || !cicloId) {
                $("#asignacionCurso").empty().append('<option value="">Seleccione grupo primero...</option>').prop("disabled", true);
                $("#infoCursoHoras").hide();
                return;
            }

            // Cargar cursos del ciclo con información de completado
            $.ajax({
                url: `/horarios/cursos/grupo/${grupoId}/ciclo/${cicloId}`,
                method: "GET",
                success: function(cursos) {
                    const select = $("#asignacionCurso");
                    select.empty().append('<option value="">Seleccione...</option>');

                    if (cursos.length === 0) {
                        select.append('<option value="" disabled>No hay cursos registrados para este ciclo</option>');
                    } else {
                        cursos.forEach(curso => {
                            // Crear opción con información de estado
                            const option = new Option(
                                `${curso.nombre} ${getEstadoCompletadoTexto(curso.estado)}`,
                                curso.idCurso
                            );

                            // Añadir atributos de datos para usar después
                            $(option).data('estado', curso.estado);
                            $(option).data('horasTotales', curso.horasSemana);
                            $(option).data('horasAsignadas', curso.horasAsignadas);

                            // Colorear según estado
                            if (curso.estado === 'COMPLETO') {
                                $(option).addClass('text-success');
                            } else if (curso.estado === 'PARCIAL') {
                                $(option).addClass('text-warning');
                            } else {
                                $(option).addClass('text-danger'); // Sin asignar
                            }

                            select.append(option);
                        });
                    }

                    select.prop("disabled", false);
                },
                error: function() {
                    alert("Error al cargar los cursos");
                }
            });
        });

// Función para obtener texto descriptivo del estado de completado
        function getEstadoCompletadoTexto(estado) {
            switch(estado) {
                case 'COMPLETO':
                    return '✓ (Completado)';
                case 'PARCIAL':
                    return '⚠ (Parcial)';
                case 'SIN_ASIGNAR':
                    return '⚠ (Por asignar)';
                default:
                    return '';
            }
        }
        // Función para resetear selecciones posteriores a un campo
        function resetearSeleccionesPosteriores(campoActual) {
            const campos = ["asignacionModalidad", "asignacionCarrera", "asignacionCiclo", "asignacionGrupo", "asignacionCurso"];
            const indiceActual = campos.indexOf(campoActual);

            if (indiceActual >= 0) {
                for (let i = indiceActual + 1; i < campos.length; i++) {
                    const campo = campos[i];
                    let placeholder = "Seleccione...";

                    switch(campo) {
                        case "asignacionCarrera":
                            placeholder = "Seleccione modalidad primero...";
                            break;
                        case "asignacionCiclo":
                            placeholder = "Seleccione carrera primero...";
                            break;
                        case "asignacionGrupo":
                            placeholder = "Seleccione ciclo primero...";
                            break;
                        case "asignacionCurso":
                            placeholder = "Seleccione grupo primero...";
                            break;
                    }

                    $(`#${campo}`).empty().append(`<option value="">${placeholder}</option>`).prop("disabled", true);
                }
            }

            // Ocultar información de horas
            $("#infoCursoHoras, #infoBloquesSeleccionados").hide();
        }


// Modificar el evento de cambio de tipo de sesión para solo activarse cuando el curso es mixto
        $("#asignacionTipoSesion").change(function() {
            const tipoSesion = $(this).val();
            if (!tipoSesion) {
                $("#asignacionAmbiente").empty().append('<option value="">Seleccione tipo de sesión primero...</option>');
                return;
            }

            const tipoAmbiente = tipoSesion === "Teorica" ? "Teorico" : "Practico";
            cargarAmbientesPorTipo(tipoAmbiente);
        });

        // Evento al cambiar el filtro de modalidad
        $("#filtroCursoModalidad").change(function() {
            cargarCursos();
        });

        // Añadir código para manejar la edición de cursos
        function cargarCursos() {
            const modalidadId = $("#filtroCursoModalidad").val();
            const filtros = { modalidadId: modalidadId || null };

            $.ajax({
                url: `/horarios/cursos/filtrar`,
                method: "GET",
                data: filtros,
                success: function(cursos) {
                    const tbody = $("#tablaCursos tbody");
                    tbody.empty();

                    if (cursos.length === 0) {
                        tbody.append(`<tr><td colspan="5" class="text-center">No hay cursos registrados</td></tr>`);
                        return;
                    }

                    cursos.forEach(curso => {
                        const tr = $("<tr>");
                        tr.append(`<td>${curso.nombre}</td>`);
                        tr.append(`<td>${curso.cicloNombre}</td>`);
                        tr.append(`<td>${curso.carreraNombre}</td>`);
                        tr.append(`<td>${curso.tipo}</td>`);
                        tr.append(`
                    <td>
                        <button class="btn btn-sm btn-warning btn-editar-curso me-1" data-id="${curso.idCurso}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-eliminar-curso" data-id="${curso.idCurso}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `);
                        tbody.append(tr);
                    });

                    // Evento para editar curso
                    $(".btn-editar-curso").click(function() {
                        const cursoId = $(this).data("id");
                        cargarCursoParaEditar(cursoId);
                    });

                    // Evento para eliminar curso
                    $(".btn-eliminar-curso").click(function() {
                        const cursoId = $(this).data("id");
                        if (confirm("¿Está seguro de eliminar este curso?")) {
                            eliminarCurso(cursoId);
                        }
                    });
                }
            });
        }



        // Similares funciones de carga y gestión para los demás modales de configuración
        $("#btnGuardarModalidad").click(function() {
            const nombre = $("#modalidadNombre").val();
            const duracion = $("#modalidadDuracion").val();

            if (!nombre || !duracion) {
                alert("Todos los campos son obligatorios");
                return;
            }

            $.ajax({
                url: "/cursos/modalidades",
                method: "POST",
                data: {
                    nombre: nombre,
                    duracionAnios: duracion
                },
                success: function(modalidad) {
                    // Limpiar el formulario
                    $("#formModalidad")[0].reset();

                    // Actualizar la tabla de modalidades
                    cargarModalidades();

                    // Agregar la nueva modalidad a todos los select que la usan
                    const option = new Option(modalidad.nombre, modalidad.idModalidad);
                    $("#asignacionModalidad").append(option);
                    $("#cursoModalidad").append(option.cloneNode(true));
                    $("#filtroCursoModalidad").append(option.cloneNode(true));

                    alert("Modalidad educativa guardada con éxito");
                },
                error: function(xhr) {
                    if (xhr.status === 400) {
                        alert("Error: " + (xhr.responseJSON ? xhr.responseJSON.message : "No se pudo guardar la modalidad"));
                    } else {
                        alert("Error al guardar la modalidad educativa");
                    }
                }
            });
        });

// Función para cargar las modalidades
        function cargarModalidades() {
            $.ajax({
                url: "/cursos/modalidades",
                method: "GET",
                success: function(modalidades) {
                    const tbody = $("#tablaModalidades tbody");
                    tbody.empty();

                    if (modalidades.length === 0) {
                        tbody.append(`<tr><td colspan="3" class="text-center">No hay modalidades registradas</td></tr>`);
                        return;
                    }

                    modalidades.forEach(modalidad => {
                        const tr = $("<tr>");
                        tr.append(`<td>${modalidad.nombre}</td>`);
                        tr.append(`<td>${modalidad.duracionAnios} año(s)</td>`);
                        tr.append(`
                    <td>
                        <button class="btn btn-sm btn-danger btn-eliminar-modalidad" data-id="${modalidad.idModalidad}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `);
                        tbody.append(tr);
                    });

                    // Evento para eliminar modalidad
                    $(".btn-eliminar-modalidad").click(function() {
                        const modalidadId = $(this).data("id");
                        if (confirm("¿Está seguro de eliminar esta modalidad educativa?")) {
                            eliminarModalidad(modalidadId);
                        }
                    });
                },
                error: function() {
                    alert("Error al cargar las modalidades educativas");
                }
            });
        }

// Función para eliminar una modalidad
        function eliminarModalidad(id) {
            $.ajax({
                url: `/cursos/modalidades/${id}`,
                method: "DELETE",
                success: function() {
                    cargarModalidades();

                    // Actualizar los select que contienen las modalidades
                    $(`#asignacionModalidad option[value="${id}"]`).remove();
                    $(`#cursoModalidad option[value="${id}"]`).remove();
                    $(`#filtroCursoModalidad option[value="${id}"]`).remove();

                    alert("Modalidad eliminada con éxito");
                },
                error: function(xhr) {
                    if (xhr.status === 400) {
                        alert("No se puede eliminar la modalidad porque tiene carreras asociadas");
                    } else {
                        alert("Error al eliminar la modalidad");
                    }
                }
            });
        }

// Cargar modalidades al abrir el modal
        $("#modalModalidad").on('shown.bs.modal', function() {
            cargarModalidades();
        });

        // Se implementarían de manera análoga a las funciones ya mostradas
    });
    // Gestión de carreras
    $("#btnGuardarCarrera").click(function() {
        const modalidadId = $("#carreraModalidad").val();
        const nombre = $("#carreraNombre").val();

        if (!modalidadId || !nombre) {
            alert("Todos los campos son obligatorios");
            return;
        }

        $.ajax({
            url: "/cursos/carreras",
            method: "POST",
            data: {
                nombre: nombre,
                modalidadId: modalidadId
            },
            success: function(carrera) {
                // Limpiar el formulario
                $("#formCarrera")[0].reset();

                // Actualizar la tabla de carreras
                cargarCarreras();

                alert("Carrera guardada con éxito");
            },
            error: function(xhr) {
                if (xhr.status === 400) {
                    alert("Error: " + (xhr.responseJSON ? xhr.responseJSON.message : "No se pudo guardar la carrera"));
                } else {
                    alert("Error al guardar la carrera");
                }
            }
        });
    });

    // Función para cargar las carreras
    function cargarCarreras() {
        $.ajax({
            url: "/cursos/carreras",
            method: "GET",
            success: function(carreras) {
                const tbody = $("#tablaCarreras tbody");
                tbody.empty();

                if (carreras.length === 0) {
                    tbody.append(`<tr><td colspan="3" class="text-center">No hay carreras registradas</td></tr>`);
                    return;
                }

                carreras.forEach(carrera => {
                    const tr = $("<tr>");
                    tr.append(`<td>${carrera.nombre}</td>`);
                    tr.append(`<td>${carrera.modalidad.nombre}</td>`);
                    tr.append(`
                    <td>
                        <button class="btn btn-sm btn-danger btn-eliminar-carrera" data-id="${carrera.idCarrera}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `);
                    tbody.append(tr);
                });

                // Evento para eliminar carrera
                $(".btn-eliminar-carrera").click(function() {
                    const carreraId = $(this).data("id");
                    if (confirm("¿Está seguro de eliminar esta carrera?")) {
                        eliminarCarrera(carreraId);
                    }
                });
            },
            error: function() {
                alert("Error al cargar las carreras");
            }
        });
    }

    // Función para eliminar una carrera
    function eliminarCarrera(id) {
        $.ajax({
            url: `/cursos/carreras/${id}`,
            method: "DELETE",
            success: function() {
                cargarCarreras();
                alert("Carrera eliminada con éxito");
            },
            error: function(xhr) {
                if (xhr.status === 400) {
                    alert("No se puede eliminar la carrera porque tiene ciclos asociados");
                } else {
                    alert("Error al eliminar la carrera");
                }
            }
        });
    }

    // Cargar modalidades al abrir el modal de carreras
    $("#modalCarrera").on('shown.bs.modal', function() {
        // Cargar modalidades para el select
        $.ajax({
            url: "/cursos/modalidades",
            method: "GET",
            success: function(modalidades) {
                const select = $("#carreraModalidad");
                select.empty();
                select.append('<option value="">Seleccione...</option>');

                modalidades.forEach(modalidad => {
                    select.append(new Option(modalidad.nombre, modalidad.idModalidad));
                });
            }
        });

        // Cargar tabla de carreras
        cargarCarreras();
    });
    // Gestión de ciclos
    $("#cicloModalidad").change(function() {
        const modalidadId = $(this).val();
        if (!modalidadId) {
            $("#cicloCarrera").empty().append('<option value="">Seleccione modalidad primero...</option>').prop("disabled", true);
            return;
        }

        // Cargar carreras por modalidad
        $.ajax({
            url: `/cursos/carreras/modalidad/${modalidadId}`,
            method: "GET",
            success: function(carreras) {
                const select = $("#cicloCarrera");
                select.empty().append('<option value="">Seleccione...</option>');

                carreras.forEach(carrera => {
                    select.append(new Option(carrera.nombre, carrera.idCarrera));
                });

                select.prop("disabled", false);
            }
        });
    });

    $("#btnGuardarCiclo").click(function() {
        const carreraId = $("#cicloCarrera").val();
        const numero = $("#cicloNumero").val();

        if (!carreraId || !numero) {
            alert("Todos los campos son obligatorios");
            return;
        }

        $.ajax({
            url: "/cursos/ciclos",
            method: "POST",
            data: {
                numero: numero,
                carreraId: carreraId
            },
            success: function(ciclo) {
                // Limpiar el formulario
                $("#formCiclo")[0].reset();
                $("#cicloCarrera").prop("disabled", true);

                // Actualizar la tabla de ciclos
                cargarCiclos();

                alert("Ciclo guardado con éxito");
            },
            error: function(xhr) {
                if (xhr.status === 400) {
                    alert("Error: " + (xhr.responseJSON ? xhr.responseJSON.message : "No se pudo guardar el ciclo"));
                } else {
                    alert("Error al guardar el ciclo");
                }
            }
        });
    });

    // Función para cargar los ciclos
    function cargarCiclos() {
        $.ajax({
            url: "/cursos/ciclos",
            method: "GET",
            success: function(ciclos) {
                const tbody = $("#tablaCiclos tbody");
                tbody.empty();

                if (ciclos.length === 0) {
                    tbody.append(`<tr><td colspan="4" class="text-center">No hay ciclos registrados</td></tr>`);
                    return;
                }

                ciclos.forEach(ciclo => {
                    const tr = $("<tr>");
                    tr.append(`<td>Ciclo ${ciclo.numero}</td>`);
                    tr.append(`<td>${ciclo.carrera.nombre}</td>`);
                    tr.append(`<td>${ciclo.carrera.modalidad.nombre}</td>`);
                    tr.append(`
                    <td>
                        <button class="btn btn-sm btn-danger btn-eliminar-ciclo" data-id="${ciclo.idCiclo}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `);
                    tbody.append(tr);
                });

                // Evento para eliminar ciclo
                $(".btn-eliminar-ciclo").click(function() {
                    const cicloId = $(this).data("id");
                    if (confirm("¿Está seguro de eliminar este ciclo?")) {
                        eliminarCiclo(cicloId);
                    }
                });
            },
            error: function() {
                alert("Error al cargar los ciclos");
            }
        });
    }

    // Función para eliminar un ciclo
    function eliminarCiclo(id) {
        $.ajax({
            url: `/cursos/ciclos/${id}`,
            method: "DELETE",
            success: function() {
                cargarCiclos();
                alert("Ciclo eliminado con éxito");
            },
            error: function(xhr) {
                if (xhr.status === 400) {
                    alert("No se puede eliminar el ciclo porque tiene cursos o grupos asociados");
                } else {
                    alert("Error al eliminar el ciclo");
                }
            }
        });
    }

    // Cargar datos al abrir el modal de ciclos
    $("#modalCiclo").on('shown.bs.modal', function() {
        // Cargar modalidades para el select
        $.ajax({
            url: "/cursos/modalidades",
            method: "GET",
            success: function(modalidades) {
                const select = $("#cicloModalidad");
                select.empty();
                select.append('<option value="">Seleccione...</option>');

                modalidades.forEach(modalidad => {
                    select.append(new Option(modalidad.nombre, modalidad.idModalidad));
                });
            }
        });

        // Cargar tabla de ciclos
        cargarCiclos();
    });
    // Evento para cambio de modalidad (resetea la selección de carrera y ciclo)
    $("#cursoModalidad").change(function() {
        const modalidadId = $(this).val();
        const cursoId = $("#cursoId").val(); // Si hay ID, estamos en modo edición

        // Resetear los selects de carrera y ciclo
        $("#cursoCarrera").empty().append('<option value="">Seleccione modalidad primero...</option>').prop("disabled", true);
        $("#cursoCiclo").empty().append('<option value="">Seleccione carrera primero...</option>').prop("disabled", true);

        if (!modalidadId) {
            return;
        }

        // Mostrar indicador de carga
        const loadingMsg = $('<div class="text-primary small mt-1">Cargando carreras...</div>');
        $("#cursoCarrera").after(loadingMsg);

        // Cargar carreras por modalidad
        $.ajax({
            url: `/cursos/carreras/modalidad/${modalidadId}`,
            method: "GET",
            success: function(carreras) {
                loadingMsg.remove();

                const select = $("#cursoCarrera");
                select.empty().append('<option value="">Seleccione...</option>');

                if (carreras.length === 0) {
                    select.append('<option value="" disabled>No hay carreras disponibles</option>');
                    return;
                }

                carreras.forEach(carrera => {
                    select.append(new Option(carrera.nombre, carrera.idCarrera));
                });

                select.prop("disabled", false);
            },
            error: function() {
                loadingMsg.remove();
                alert("Error al cargar las carreras");
            }
        });
    });



    // Evento para cambio de carrera (resetea la selección de ciclo)
    $("#cursoCarrera").change(function() {
        const carreraId = $(this).val();

        // Resetear el select de ciclo
        $("#cursoCiclo").empty().append('<option value="">Seleccione carrera primero...</option>').prop("disabled", true);

        if (!carreraId) {
            return;
        }

        // Mostrar indicador de carga
        const loadingMsg = $('<div class="text-primary small mt-1">Cargando ciclos...</div>');
        $("#cursoCiclo").after(loadingMsg);

        // Cargar ciclos por carrera
        $.ajax({
            url: `/cursos/ciclos/carrera/${carreraId}`,
            method: "GET",
            success: function(ciclos) {
                loadingMsg.remove();

                const select = $("#cursoCiclo");
                select.empty().append('<option value="">Seleccione...</option>');

                if (ciclos.length === 0) {
                    select.append('<option value="" disabled>No hay ciclos disponibles</option>');
                    return;
                }

                ciclos.forEach(ciclo => {
                    select.append(new Option(`Ciclo ${ciclo.numero}`, ciclo.idCiclo));
                });

                select.prop("disabled", false);
            },
            error: function() {
                loadingMsg.remove();
                alert("Error al cargar los ciclos");
            }
        });
    });
    // Modificar la función para guardar/actualizar curso
    // Función para guardar o actualizar un curso
    $("#btnGuardarCurso").click(function() {
        const id = $("#cursoId").val();
        const cicloId = $("#cursoCiclo").val();
        const nombre = $("#cursoNombre").val();
        const tipo = $("#cursoTipo").val();
        const horas = $("#cursoHoras").val();

        if (!cicloId || !nombre || !tipo || !horas) {
            alert("Todos los campos son obligatorios");
            return;
        }

        const cursoDTO = {
            nombre: nombre,
            tipo: tipo,
            horasSemana: parseInt(horas)
        };

        let url = `/cursos?cicloId=${cicloId}`;
        let method = "POST";

        // Si hay ID, es una actualización
        if (id) {
            url = `/cursos/${id}?cicloId=${cicloId}`;
            method = "PUT";
            cursoDTO.idCurso = parseInt(id);
        }

        $.ajax({
            url: url,
            method: method,
            contentType: "application/json",
            data: JSON.stringify(cursoDTO),
            success: function(curso) {
                // Limpiar el formulario
                resetearFormularioCurso();

                // Cambiar a la pestaña de lista y recargar
                $("#lista-cursos-tab").tab("show");
                cargarCursos();

                alert(id ? "Curso actualizado con éxito" : "Curso guardado con éxito");
            },
            error: function(xhr) {
                if (xhr.status === 400) {
                    alert("Error: Ya existe un curso con ese nombre en el mismo ciclo");
                } else {
                    alert("Error al " + (id ? "actualizar" : "guardar") + " el curso");
                }
            }
        });
    });
    function resetearFormularioCurso() {
        // Limpiar el ID del curso y restablecer textos
        $("#cursoId").val("");
        $("#nuevoCursoTitle").text("Nuevo Curso");
        $("#btnGuardarCurso").text("Guardar Curso");

        // Restablecer todos los campos del formulario
        $("#formCurso")[0].reset();

        // Limpiar y desactivar selects dependientes
        $("#cursoCarrera").empty().append('<option value="">Seleccione modalidad primero...</option>').prop("disabled", true);
        $("#cursoCiclo").empty().append('<option value="">Seleccione carrera primero...</option>').prop("disabled", true);

        // Asegurarse de que todos los elementos estén habilitados
        $("#cursoModalidad, #cursoNombre, #cursoTipo, #cursoHoras, #btnCancelarCurso, #btnGuardarCurso").prop("disabled", false);

        // Eliminar cualquier mensaje de carga o error que pudiera estar presente
        $("#cargando-curso, .text-primary.small.mt-1").remove();
    }



    // Evento al hacer clic en "Nuevo" (para asegurarnos de resetear el formulario)
    $("#nuevo-curso-tab").on('shown.bs.tab', function() {
        resetearFormularioCurso();
    });

    // Cargar cursos en la tabla
    // Cargar cursos
    function cargarCursos() {
        const modalidadId = $("#filtroCursoModalidad").val();
        const filtros = { modalidadId: modalidadId || null };

        $.ajax({
            url: `/horarios/cursos/filtrar`,
            method: "GET",
            data: filtros,
            success: function(cursos) {
                const tbody = $("#tablaCursos tbody");
                tbody.empty();

                if (cursos.length === 0) {
                    tbody.append(`<tr><td colspan="5" class="text-center">No hay cursos registrados</td></tr>`);
                    return;
                }

                cursos.forEach(curso => {
                    const tr = $("<tr>");
                    tr.append(`<td>${curso.nombre}</td>`);
                    tr.append(`<td>${curso.cicloNombre}</td>`);
                    tr.append(`<td>${curso.carreraNombre}</td>`);
                    tr.append(`<td>${curso.tipo}</td>`);
                    tr.append(`
                    <td>
                        <button class="btn btn-sm btn-warning btn-editar-curso me-1" data-id="${curso.idCurso}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-eliminar-curso" data-id="${curso.idCurso}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `);
                    tbody.append(tr);
                });

                // Evento para editar curso
                $(".btn-editar-curso").click(function() {
                    const cursoId = $(this).data("id");
                    cargarCursoParaEditar(cursoId);
                });

                // Evento para eliminar curso
                $(".btn-eliminar-curso").click(function() {
                    const cursoId = $(this).data("id");
                    if (confirm("¿Está seguro de eliminar este curso?")) {
                        eliminarCurso(cursoId);
                    }
                });
            }
        });
    }
    // Evento al hacer clic en "Cancelar"
    $("#btnCancelarCurso").click(function() {
        resetearFormularioCurso();
        $("#lista-cursos-tab").tab("show");
    });




    // Función para eliminar un curso
    function eliminarCurso(id) {
        $.ajax({
            url: `/cursos/${id}`,
            method: "DELETE",
            success: function() {
                cargarCursos();
                alert("Curso eliminado con éxito");
            },
            error: function(xhr) {
                if (xhr.status === 400) {
                    alert("No se puede eliminar el curso porque tiene asignaciones");
                } else {
                    alert("Error al eliminar el curso");
                }
            }
        });
    }

    // Cargar la lista de cursos al abrir el modal
    // Cargar cursos al abrir el modal
    $("#modalCurso").on('shown.bs.modal', function() {
        cargarCursos();
        resetearFormularioCurso();
    });
    // Gestión de grupos - Código a agregar a tu archivo JavaScript principal

    // Eventos de selección encadenados para los filtros de grupos
    $("#filtroGrupoModalidad").change(function() {
        const modalidadId = $(this).val();
        if (!modalidadId) {
            $("#filtroGrupoCarrera").empty().append('<option value="">Seleccione modalidad primero...</option>').prop("disabled", true);
            cargarGrupos();
            return;
        }

        // Cargar carreras por modalidad
        $.ajax({
            url: `/cursos/carreras/modalidad/${modalidadId}`,
            method: "GET",
            success: function(carreras) {
                const select = $("#filtroGrupoCarrera");
                select.empty().append('<option value="">Todas las carreras</option>');

                carreras.forEach(carrera => {
                    select.append(new Option(carrera.nombre, carrera.idCarrera));
                });

                select.prop("disabled", false);
                cargarGrupos(modalidadId, null);
            },
            error: function() {
                alert("Error al cargar las carreras");
            }
        });
    });

    $("#filtroGrupoCarrera").change(function() {
        const modalidadId = $("#filtroGrupoModalidad").val();
        const carreraId = $(this).val();
        cargarGrupos(modalidadId, carreraId);
    });

    // Eventos de selección encadenados para el formulario de grupo
    $("#grupoModalidad").change(function() {
        const modalidadId = $(this).val();
        if (!modalidadId) {
            $("#grupoCarrera").empty().append('<option value="">Seleccione modalidad primero...</option>').prop("disabled", true);
            return;
        }

        // Cargar carreras por modalidad
        $.ajax({
            url: `/cursos/carreras/modalidad/${modalidadId}`,
            method: "GET",
            success: function(carreras) {
                const select = $("#grupoCarrera");
                select.empty().append('<option value="">Seleccione...</option>');

                carreras.forEach(carrera => {
                    select.append(new Option(carrera.nombre, carrera.idCarrera));
                });

                select.prop("disabled", false);
            },
            error: function() {
                alert("Error al cargar las carreras");
            }
        });
    });

    $("#grupoCarrera").change(function() {
        const carreraId = $(this).val();
        if (!carreraId) {
            $("#grupoCiclo").empty().append('<option value="">Seleccione carrera primero...</option>').prop("disabled", true);
            return;
        }

        // Cargar ciclos por carrera
        $.ajax({
            url: `/cursos/ciclos/carrera/${carreraId}`,
            method: "GET",
            success: function(ciclos) {
                const select = $("#grupoCiclo");
                select.empty().append('<option value="">Seleccione...</option>');

                ciclos.forEach(ciclo => {
                    select.append(new Option(`Ciclo ${ciclo.numero}`, ciclo.idCiclo));
                });

                select.prop("disabled", false);
            },
            error: function() {
                alert("Error al cargar los ciclos");
            }
        });
    });

    // Funcionalidad para guardar un nuevo grupo
    $("#btnGuardarGrupo").click(function() {
        const cicloId = $("#grupoCiclo").val();
        const nombre = $("#grupoNombre").val();

        if (!cicloId || !nombre) {
            alert("Todos los campos son obligatorios");
            return;
        }

        $.ajax({
            url: "/cursos/grupos",
            method: "POST",
            data: {
                nombre: nombre,
                cicloId: cicloId
            },
            success: function(grupo) {
                // Limpiar el formulario
                $("#formGrupo")[0].reset();
                $("#grupoCarrera, #grupoCiclo").prop("disabled", true);

                // Cambiar a la pestaña de lista y recargar la tabla de grupos
                $("#lista-grupos-tab").tab("show");
                cargarGrupos();

                alert("Grupo guardado con éxito");
            },
            error: function(xhr) {
                if (xhr.status === 400) {
                    alert("Error: Ya existe un grupo con ese nombre en el mismo ciclo");
                } else {
                    alert("Error al guardar el grupo");
                }
            }
        });
    });

    // Función para cargar grupos
    function cargarGrupos(modalidadId = null, carreraId = null) {
        let url = "/cursos/grupos";
        let params = {};

        if (modalidadId && carreraId) {
            // Si tenemos modalidad y carrera, filtramos por carrera (que ya implica modalidad)
            url = `/horarios/grupos/filtrar`;
            params = { carreraId: carreraId };
        } else if (modalidadId) {
            // Si solo tenemos modalidad, filtramos por modalidad
            url = `/horarios/grupos/filtrar`;
            params = { modalidadId: modalidadId };
        }

        $.ajax({
            url: url,
            method: "GET",
            data: params,
            success: function(grupos) {
                const tbody = $("#tablaGrupos tbody");
                tbody.empty();

                if (grupos.length === 0) {
                    tbody.append(`<tr><td colspan="5" class="text-center">No hay grupos registrados</td></tr>`);
                    return;
                }

                grupos.forEach(grupo => {
                    const tr = $("<tr>");
                    tr.append(`<td>${grupo.nombre}</td>`);
                    tr.append(`<td>${grupo.cicloNombre}</td>`);

                    // Extraer carrera y modalidad del cicloNombre si está disponible, de lo contrario mostrar N/A
                    const carreraNombre = grupo.carreraNombre || "N/A";
                    const modalidadNombre = grupo.modalidadNombre || "N/A";

                    tr.append(`<td>${carreraNombre}</td>`);
                    tr.append(`<td>${modalidadNombre}</td>`);
                    tr.append(`
                    <td>
                        <button class="btn btn-sm btn-danger btn-eliminar-grupo" data-id="${grupo.idGrupo}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `);
                    tbody.append(tr);
                });

                // Evento para eliminar grupo
                $(".btn-eliminar-grupo").click(function() {
                    const grupoId = $(this).data("id");
                    if (confirm("¿Está seguro de eliminar este grupo? Esta acción puede afectar a las asignaciones existentes.")) {
                        eliminarGrupo(grupoId);
                    }
                });
            },
            error: function() {
                alert("Error al cargar los grupos");
            }
        });
    }

    // Función para eliminar un grupo
    function eliminarGrupo(id) {
        $.ajax({
            url: `/cursos/grupos/${id}`,
            method: "DELETE",
            success: function() {
                cargarGrupos();
                alert("Grupo eliminado con éxito");
            },
            error: function(xhr) {
                if (xhr.status === 400) {
                    alert("No se puede eliminar el grupo porque tiene asignaciones de horario asociadas");
                } else {
                    alert("Error al eliminar el grupo");
                }
            }
        });
    }

    // Cargar datos al abrir el modal de grupos
    $("#modalGrupo").on('shown.bs.modal', function() {
        // Limpiar filtros
        $("#filtroGrupoModalidad").val("");
        $("#filtroGrupoCarrera").empty().append('<option value="">Seleccione modalidad primero...</option>').prop("disabled", true);

        // Cargar todos los grupos
        cargarGrupos();
    });
    // Gestión de turnos - Código a agregar a tu archivo JavaScript principal

    // Cargar turnos
    function cargarTurnos() {
        $.ajax({
            url: "/ambientes/turnos",
            method: "GET",
            success: function(turnos) {
                const tbody = $("#tablaTurnos tbody");
                tbody.empty();

                if (turnos.length === 0) {
                    tbody.append(`<tr><td colspan="4" class="text-center">No hay turnos registrados</td></tr>`);
                    return;
                }

                turnos.forEach(turno => {
                    const horaInicio = turno.horaInicio ? turno.horaInicio.substring(0, 5) : "";
                    const horaFin = turno.horaFin ? turno.horaFin.substring(0, 5) : "";

                    // Calcular cantidad de bloques
                    const cantidadBloques = turno.bloques ? turno.bloques.length : 0;

                    const tr = $("<tr>");
                    tr.append(`<td>${turno.nombre}</td>`);
                    tr.append(`<td>${horaInicio} - ${horaFin}</td>`);
                    tr.append(`<td>${cantidadBloques} bloque(s)</td>`);
                    tr.append(`
                    <td>
                        <button class="btn btn-sm btn-danger btn-eliminar-turno" data-id="${turno.idTurno}">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-info btn-ver-bloques" data-id="${turno.idTurno}">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                `);
                    tbody.append(tr);
                });

                // Evento para eliminar turno
                $(".btn-eliminar-turno").click(function() {
                    const turnoId = $(this).data("id");
                    if (confirm("¿Está seguro de eliminar este turno? Esta acción eliminará todos sus bloques si no tienen asignaciones.")) {
                        eliminarTurno(turnoId);
                    }
                });

                // Evento para ver bloques del turno
                $(".btn-ver-bloques").click(function() {
                    const turnoId = $(this).data("id");
                    $("#bloquesTurno").val(turnoId).trigger("change");
                    $("#generar-bloques-tab").tab("show");
                });

                // Actualizar también el selector de turnos en la pestaña de generar bloques
                const selectTurnos = $("#bloquesTurno");
                selectTurnos.empty();
                selectTurnos.append('<option value="">Seleccione...</option>');

                turnos.forEach(turno => {
                    selectTurnos.append(new Option(`${turno.nombre} (${turno.horaInicio.substring(0, 5)} - ${turno.horaFin.substring(0, 5)})`, turno.idTurno));
                });
            },
            error: function() {
                alert("Error al cargar los turnos");
            }
        });
    }

    // Funcionalidad para guardar un nuevo turno
    $("#btnGuardarTurno").click(function() {
        const nombre = $("#turnoNombre").val();
        const horaInicio = $("#turnoHoraInicio").val();
        const horaFin = $("#turnoHoraFin").val();

        if (!nombre || !horaInicio || !horaFin) {
            alert("Todos los campos son obligatorios");
            return;
        }

        if (horaInicio >= horaFin) {
            alert("La hora de inicio debe ser menor a la hora de fin");
            return;
        }

        $.ajax({
            url: "/ambientes/turnos",
            method: "POST",
            data: {
                nombre: nombre,
                horaInicio: horaInicio,
                horaFin: horaFin
            },
            success: function(turno) {
                // Limpiar el formulario
                $("#formTurno")[0].reset();

                // Cambiar a la pestaña de lista y recargar la tabla de turnos
                $("#lista-turnos-tab").tab("show");
                cargarTurnos();

                alert("Turno guardado con éxito");
            },
            error: function(xhr) {
                if (xhr.status === 400) {
                    alert("Error: Ya existe un turno con ese nombre");
                } else {
                    alert("Error al guardar el turno");
                }
            }
        });
    });

    // Función para eliminar un turno
    function eliminarTurno(id) {
        $.ajax({
            url: `/ambientes/turnos/${id}`,
            method: "DELETE",
            success: function() {
                cargarTurnos();
                alert("Turno eliminado con éxito");
            },
            error: function(xhr) {
                if (xhr.status === 400) {
                    alert("No se puede eliminar el turno porque sus bloques tienen asignaciones");
                } else {
                    alert("Error al eliminar el turno");
                }
            }
        });
    }

    // Evento al cambiar el turno seleccionado en la pestaña de generar bloques
    $("#bloquesTurno").change(function() {
        const turnoId = $(this).val();

        if (!turnoId) {
            // Limpiar la tabla de bloques
            $("#tablaBloquesTurno tbody").empty();
            return;
        }

        // Cargar bloques del turno seleccionado
        cargarBloquesTurno(turnoId);
    });

    // Función para cargar los bloques de un turno
    function cargarBloquesTurno(turnoId) {
        $.ajax({
            url: `/ambientes/bloques/turno/${turnoId}`,
            method: "GET",
            success: function(bloques) {
                const tbody = $("#tablaBloquesTurno tbody");
                tbody.empty();

                if (bloques.length === 0) {
                    tbody.append(`<tr><td colspan="4" class="text-center">No hay bloques generados para este turno</td></tr>`);
                    return;
                }

                // Ordenar bloques por orden
                bloques.sort((a, b) => a.orden - b.orden);

                bloques.forEach(bloque => {
                    const horaInicio = bloque.horaInicio.substring(0, 5);
                    const horaFin = bloque.horaFin.substring(0, 5);

                    // Calcular duración en minutos
                    const inicioPartes = horaInicio.split(":");
                    const finPartes = horaFin.split(":");
                    const inicioMinutos = parseInt(inicioPartes[0]) * 60 + parseInt(inicioPartes[1]);
                    const finMinutos = parseInt(finPartes[0]) * 60 + parseInt(finPartes[1]);
                    const duracionMinutos = finMinutos - inicioMinutos;

                    const tr = $("<tr>");
                    tr.append(`<td>${bloque.orden}</td>`);
                    tr.append(`<td>${horaInicio}</td>`);
                    tr.append(`<td>${horaFin}</td>`);
                    tr.append(`<td>${duracionMinutos} min</td>`);
                    tbody.append(tr);
                });
            },
            error: function() {
                alert("Error al cargar los bloques del turno");
            }
        });
    }

    // Funcionalidad para generar bloques para un turno
    $("#btnGenerarBloques").click(function() {
        const turnoId = $("#bloquesTurno").val();
        const duracionMinutos = $("#bloquesDuracion").val();

        if (!turnoId || !duracionMinutos) {
            alert("Todos los campos son obligatorios");
            return;
        }

        if (duracionMinutos < 30 || duracionMinutos > 120) {
            alert("La duración debe estar entre 30 y 120 minutos");
            return;
        }

        if (confirm("¿Está seguro de generar bloques para este turno? Se eliminarán los bloques existentes si no tienen asignaciones.")) {
            $.ajax({
                url: "/ambientes/bloques/generar",
                method: "POST",
                data: {
                    turnoId: turnoId,
                    duracionMinutos: duracionMinutos
                },
                success: function(bloques) {
                    // Mostrar los bloques generados
                    cargarBloquesTurno(turnoId);
                    alert(`Se han generado ${bloques.length} bloques para el turno seleccionado`);
                },
                error: function(xhr) {
                    if (xhr.status === 400) {
                        alert("Error: No se pueden generar bloques porque el turno tiene bloques con asignaciones");
                    } else {
                        alert("Error al generar los bloques");
                    }
                }
            });
        }
    });

    // Cargar datos al abrir el modal de turnos
    $("#modalTurno").on('shown.bs.modal', function() {
        cargarTurnos();
        $("#tablaBloquesTurno tbody").empty();
    });
    // Gestión de ambientes - Código a agregar a tu archivo JavaScript principal

    // Cargar ambientes con filtro opcional
    function cargarAmbientes(tipo = null) {
        let url = "/ambientes";
        let data = {};

        if (tipo) {
            data.tipo = tipo;
        }

        $.ajax({
            url: url,
            method: "GET",
            data: data,
            success: function(ambientes) {
                const tbody = $("#tablaAmbientes tbody");
                tbody.empty();

                if (ambientes.length === 0) {
                    tbody.append(`<tr><td colspan="4" class="text-center">No hay ambientes registrados</td></tr>`);
                    return;
                }

                ambientes.forEach(ambiente => {
                    const tr = $("<tr>");
                    tr.append(`<td>${ambiente.nombre}</td>`);
                    tr.append(`<td>${ambiente.tipo}</td>`);
                    tr.append(`<td>${ambiente.capacidad}</td>`);
                    tr.append(`
                    <td>
                        <button class="btn btn-sm btn-warning btn-editar-ambiente" data-id="${ambiente.idAmbiente}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-eliminar-ambiente" data-id="${ambiente.idAmbiente}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `);
                    tbody.append(tr);
                });

                // Evento para editar ambiente
                $(".btn-editar-ambiente").click(function() {
                    const ambienteId = $(this).data("id");
                    cargarAmbienteParaEditar(ambienteId);
                });

                // Evento para eliminar ambiente
                $(".btn-eliminar-ambiente").click(function() {
                    const ambienteId = $(this).data("id");
                    if (confirm("¿Está seguro de eliminar este ambiente? Esta acción no se puede deshacer.")) {
                        eliminarAmbiente(ambienteId);
                    }
                });
            },
            error: function() {
                alert("Error al cargar los ambientes");
            }
        });
    }

    // Cargar un ambiente para editar
    function cargarAmbienteParaEditar(id) {
        $.ajax({
            url: `/ambientes/${id}`,
            method: "GET",
            success: function(ambiente) {
                // Rellenar el formulario con los datos del ambiente
                $("#ambienteId").val(ambiente.idAmbiente);
                $("#ambienteNombre").val(ambiente.nombre);
                $("#ambienteTipo").val(ambiente.tipo);
                $("#ambienteCapacidad").val(ambiente.capacidad);

                // Cambiar a la pestaña de nuevo ambiente (que ahora será para editar)
                $("#nuevo-ambiente-tab").tab("show");

                // Cambiar el texto del botón
                $("#btnGuardarAmbiente").text("Actualizar");
            },
            error: function() {
                alert("Error al cargar el ambiente para editar");
            }
        });
    }

    // Guardar o actualizar un ambiente
    $("#btnGuardarAmbiente").click(function() {
        const id = $("#ambienteId").val();
        const nombre = $("#ambienteNombre").val();
        const tipo = $("#ambienteTipo").val();
        const capacidad = $("#ambienteCapacidad").val();

        if (!nombre || !tipo || !capacidad) {
            alert("Todos los campos son obligatorios");
            return;
        }

        const ambienteDTO = {
            idAmbiente: id || null,
            nombre: nombre,
            tipo: tipo,
            capacidad: parseInt(capacidad)
        };

        let url = "/ambientes";
        let method = "POST";

        // Si hay ID, es una actualización
        if (id) {
            url = `/ambientes/${id}`;
            method = "PUT";
        }

        $.ajax({
            url: url,
            method: method,
            contentType: "application/json",
            data: JSON.stringify(ambienteDTO),
            success: function(ambiente) {
                // Resetear el formulario
                resetearFormularioAmbiente();

                // Cambiar a la pestaña de lista y recargar la tabla
                $("#lista-ambientes-tab").tab("show");

                // Recargar con el filtro actual
                const filtroTipo = $("#filtroAmbienteTipo").val();
                cargarAmbientes(filtroTipo || null);

                alert(id ? "Ambiente actualizado con éxito" : "Ambiente guardado con éxito");
            },
            error: function(xhr) {
                if (xhr.status === 400) {
                    alert("Error: Ya existe un ambiente con ese nombre");
                } else {
                    alert("Error al guardar el ambiente");
                }
            }
        });
    });

    // Función para eliminar un ambiente
    function eliminarAmbiente(id) {
        $.ajax({
            url: `/ambientes/${id}`,
            method: "DELETE",
            success: function() {
                // Recargar con el filtro actual
                const filtroTipo = $("#filtroAmbienteTipo").val();
                cargarAmbientes(filtroTipo || null);

                alert("Ambiente eliminado con éxito");
            },
            error: function(xhr) {
                if (xhr.status === 400) {
                    alert("No se puede eliminar el ambiente porque tiene asignaciones");
                } else {
                    alert("Error al eliminar el ambiente");
                }
            }
        });
    }

    // Resetear el formulario de ambiente
    function resetearFormularioAmbiente() {
        $("#ambienteId").val("");
        $("#formAmbiente")[0].reset();
        $("#btnGuardarAmbiente").text("Guardar");
    }

    // Evento al cambiar el filtro de tipo
    $("#filtroAmbienteTipo").change(function() {
        const tipo = $(this).val();
        cargarAmbientes(tipo || null);
    });

    // Evento al hacer clic en "Nuevo" (para asegurarnos de resetear el formulario)
    $("#nuevo-ambiente-tab").on('shown.bs.tab', function() {
        resetearFormularioAmbiente();
    });

    // Cargar ambientes al abrir el modal
    $("#modalAmbiente").on('shown.bs.modal', function() {
        // Resetear filtro
        $("#filtroAmbienteTipo").val("");

        // Cargar todos los ambientes
        cargarAmbientes();
    });

</script>
<script>
    // Función para cargar curso para editar (modificada para arquitectura Thymeleaf)
    window.cargarCursoParaEditar = function(cursoId) {
        console.log('Iniciando carga de curso para editar con enfoque Thymeleaf:', cursoId);

        // Primero, asegurarse que el modal está completamente cargado
        // o mostrarlo si no está visible
        if (!$('#modalCurso').hasClass('show')) {
            $('#modalCurso').modal('show');

            // Dar tiempo para que el modal se muestre completamente
            setTimeout(function() {
                iniciarCargaDeCurso(cursoId);
            }, 500);
        } else {
            iniciarCargaDeCurso(cursoId);
        }
    };

    function iniciarCargaDeCurso(cursoId) {
        // Cambiar a la pestaña de formulario primero
        $('#nuevo-curso-tab').tab('show');

        // Mostrar indicador de carga
        $('#nuevo-curso').prepend(
            '<div id="curso-loading-overlay" class="alert alert-info" role="alert">' +
            '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ' +
            'Cargando información del curso...' +
            '</div>'
        );

        // Desactivar formulario mientras carga
        $('#formCurso select, #formCurso input, #formCurso button').prop('disabled', true);

        // Secuencia de carga de datos con patrón de error-first para mejor control
        cargarDatosCurso(cursoId);
    }

    // Patrón escalonado para manejar mejor las llamadas AJAX dependientes
    function cargarDatosCurso(cursoId) {
        $.ajax({
            url: `/cursos/${cursoId}`,
            method: 'GET',
            cache: false,
            success: function(curso) {
                console.log('Datos curso recibidos:', curso);

                // Guardar datos en variables locales para uso posterior
                window.cursoEnEdicion = curso;

                // Ahora cargar datos del ciclo
                cargarDatosCiclo(curso);
            },
            error: function(xhr) {
                console.error('Error cargando curso:', xhr);
                finalizarConError('No se pudo cargar la información del curso.');
            }
        });
    }

    function cargarDatosCiclo(curso) {
        $.ajax({
            url: `/cursos/ciclo/${curso.cicloId}`,
            method: 'GET',
            cache: false,
            success: function(cicloData) {
                console.log('Datos ciclo recibidos:', cicloData);

                // Guardar datos del ciclo
                window.cicloEnEdicion = cicloData;

                // Ahora cargar carreras de la modalidad
                cargarCarrerasDeModalidad(curso, cicloData);
            },
            error: function(xhr) {
                console.error('Error cargando ciclo:', xhr);
                finalizarConError('No se pudo cargar la información del ciclo.');
            }
        });
    }

    function cargarCarrerasDeModalidad(curso, cicloData) {
        $.ajax({
            url: `/cursos/carreras/modalidad/${cicloData.modalidadId}`,
            method: 'GET',
            cache: false,
            success: function(carreras) {
                console.log('Carreras recibidas:', carreras);

                // Guardar carreras
                window.carrerasDisponibles = carreras;

                // Cargar ciclos de la carrera
                cargarCiclosDeCarrera(curso, cicloData, carreras);
            },
            error: function(xhr) {
                console.error('Error cargando carreras:', xhr);
                finalizarConError('No se pudo cargar las carreras disponibles.');
            }
        });
    }

    function cargarCiclosDeCarrera(curso, cicloData, carreras) {
        $.ajax({
            url: `/cursos/ciclos/carrera/${cicloData.carreraId}`,
            method: 'GET',
            cache: false,
            success: function(ciclos) {
                console.log('Ciclos recibidos:', ciclos);

                // Guardar ciclos
                window.ciclosDisponibles = ciclos;

                // Ahora podemos llenar el formulario con todos los datos
                llenarFormularioCurso(curso, cicloData, carreras, ciclos);
            },
            error: function(xhr) {
                console.error('Error cargando ciclos:', xhr);
                finalizarConError('No se pudo cargar los ciclos disponibles.');
            }
        });
    }

    function llenarFormularioCurso(curso, cicloData, carreras, ciclos) {
        try {
            console.log('Iniciando llenado de formulario');

            // 1. Establecer ID y títulos
            $('#cursoId').val(curso.idCurso);
            $('#nuevoCursoTitle').text('Editar Curso');
            $('#btnGuardarCurso').text('Actualizar Curso');

            // 2. Seleccionar modalidad
            $('#cursoModalidad').val(cicloData.modalidadId);

            // 3. Llenar selector de carreras
            const carreraSelect = $('#cursoCarrera');
            carreraSelect.empty().append('<option value="">Seleccione...</option>');
            carreras.forEach(function(carrera) {
                carreraSelect.append(new Option(carrera.nombre, carrera.idCarrera));
            });
            carreraSelect.prop('disabled', false);
            carreraSelect.val(cicloData.carreraId);

            // 4. Llenar selector de ciclos
            const cicloSelect = $('#cursoCiclo');
            cicloSelect.empty().append('<option value="">Seleccione...</option>');
            ciclos.forEach(function(ciclo) {
                cicloSelect.append(new Option(`Ciclo ${ciclo.numero}`, ciclo.idCiclo));
            });
            cicloSelect.prop('disabled', false);
            cicloSelect.val(curso.cicloId);

            // 5. Completar resto del formulario
            $('#cursoNombre').val(curso.nombre);
            $('#cursoTipo').val(curso.tipo);
            $('#cursoHoras').val(curso.horasSemana);

            // 6. Habilitamos todos los controles
            $('#formCurso select, #formCurso input, #formCurso button').prop('disabled', false);

            // 7. Quitamos overlay de carga
            $('#curso-loading-overlay').remove();

            console.log('Formulario completado con éxito');
        } catch (e) {
            console.error('Error al llenar formulario:', e);
            finalizarConError('Error inesperado al llenar el formulario.');
        }
    }

    function finalizarConError(mensaje) {
        $('#curso-loading-overlay').remove();
        alert(mensaje);

        // Resetear formulario
        if (typeof resetearFormularioCurso === 'function') {
            resetearFormularioCurso();
        } else {
            $('#cursoId').val('');
            $('#nuevoCursoTitle').text('Nuevo Curso');
            $('#btnGuardarCurso').text('Guardar Curso');
            $('#formCurso')[0].reset();
            $('#cursoCarrera, #cursoCiclo').prop('disabled', true);
        }
    }

    console.log('Nueva función de edición de cursos instalada para arquitectura Thymeleaf');
</script>
</body>
</html>